<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
<meta name="description" content="ìŠ¤í…Œì´ë¸”ì½”ì¸ ëŒ€ì‹œë³´ë“œ - ì‹¤ì‹œê°„ ì‹œê°€ì´ì•¡, ì ìœ ìœ¨, ì²´ì¸ë³„ ë¶„í¬ | Herdvibe">
<title>ìŠ¤í…Œì´ë¸”ì½”ì¸ ëŒ€ì‹œë³´ë“œ</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Noto+Sans+KR:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script src="https://t1.kakaocdn.net/kakao_js_sdk/2.7.4/kakao.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html{scrollbar-width:none}
html::-webkit-scrollbar{display:none}
body{background:#000;color:#e4e4e7;font-family:'Noto Sans KR',sans-serif;min-height:100vh}

/* Nav */
.top-nav{position:sticky;top:0;z-index:100;background:rgba(0,0,0,0.85);backdrop-filter:blur(12px);border-bottom:1px solid #1a1a1a;padding:0 16px;display:flex;align-items:center;justify-content:center;gap:24px;height:52px}
.nav-logo{font-family:'JetBrains Mono',monospace;font-weight:700;font-size:15px;color:#a78bfa;white-space:nowrap;letter-spacing:-0.5px}
.nav-title{font-size:14px;font-weight:600;color:#e4e4e7;white-space:nowrap}

/* Container */
.container{max-width:960px;margin:0 auto;padding:16px 12px 60px}

/* Cards */
.card{background:#0a0a0a;border:1px solid #1a1a1a;border-radius:12px;padding:16px;margin-bottom:16px}
.card-title{font-size:14px;font-weight:600;color:#a1a1aa;margin-bottom:12px;display:flex;align-items:center;gap:6px}

/* Summary Cards */
.summary-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-bottom:16px}
.summary-card{background:#0a0a0a;border:1px solid #1a1a1a;border-radius:10px;padding:14px 16px}
.summary-label{font-size:11px;color:#71717a;font-weight:500;margin-bottom:4px}
.summary-value{font-family:'JetBrains Mono',monospace;font-size:20px;font-weight:700;color:#f4f4f5}
.summary-sub{font-family:'JetBrains Mono',monospace;font-size:12px;margin-top:2px}
.up{color:#22c55e}
.down{color:#ef4444}

/* Chart */
.chart-box{position:relative;width:100%;margin:8px 0}
.chart-wrapper{position:relative;height:340px}
.chart-wrapper canvas{width:100%!important;height:100%!important}

/* Watermark */
.watermark{position:relative}
.watermark::after{content:'Herdvibe.com';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-family:'JetBrains Mono',monospace;font-size:28px;font-weight:600;color:rgba(255,255,255,0.06);pointer-events:none;z-index:2;letter-spacing:2px}

/* Table */
.coin-table{width:100%;border-collapse:collapse}
.coin-table th{text-align:left;font-size:11px;color:#71717a;font-weight:500;padding:8px 10px;border-bottom:1px solid #1a1a1a;white-space:nowrap}
.coin-table td{padding:10px;border-bottom:1px solid #111;font-size:13px;white-space:nowrap}
.coin-table tr:hover{background:#111}
.coin-name{display:flex;align-items:center;gap:8px}
.coin-icon{width:22px;height:22px;border-radius:50%;background:#222;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:#a78bfa;flex-shrink:0}
.coin-symbol{font-family:'JetBrains Mono',monospace;font-weight:600;color:#f4f4f5;font-size:13px}
.coin-fullname{color:#71717a;font-size:11px}
.mcap-val{font-family:'JetBrains Mono',monospace;font-weight:600;color:#e4e4e7}
.change-val{font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:600}
.peg-val{font-family:'JetBrains Mono',monospace;font-size:12px}
.peg-ok{color:#22c55e}
.peg-warn{color:#eab308}
.peg-bad{color:#ef4444}
.dom-bar{height:6px;background:#1a1a1a;border-radius:3px;overflow:hidden;min-width:60px}
.dom-fill{height:100%;border-radius:3px;transition:width 0.6s ease}

/* Tabs */
.tabs{display:flex;gap:4px;margin-bottom:12px;flex-wrap:wrap}
.tab{background:#111;border:1px solid #1a1a1a;border-radius:6px;padding:6px 12px;font-size:12px;color:#a1a1aa;cursor:pointer;font-family:'Noto Sans KR',sans-serif;transition:all 0.2s}
.tab:hover{border-color:#333;color:#e4e4e7}
.tab.active{background:#a78bfa;border-color:#a78bfa;color:#000;font-weight:600}

/* Share */
.share-bar{display:flex;gap:6px;justify-content:center;margin:12px 0 4px;flex-wrap:wrap}
.share-btn{display:flex;align-items:center;gap:5px;padding:6px 12px;border-radius:6px;border:1px solid #222;background:#0a0a0a;color:#a1a1aa;font-size:11px;cursor:pointer;font-family:'Noto Sans KR',sans-serif;transition:all 0.2s}
.share-btn:hover{border-color:#444;color:#e4e4e7}
.share-btn svg{width:14px;height:14px;flex-shrink:0}
.share-btn.twitter:hover{border-color:#1d9bf0;color:#1d9bf0}
.share-btn.kakao:hover{border-color:#fee500;color:#fee500}
.share-btn.telegram:hover{border-color:#26a5e4;color:#26a5e4}
.share-btn.copy:hover{border-color:#22c55e;color:#22c55e}
.share-btn.copied{border-color:#22c55e;color:#22c55e}

/* Chain dist */
.chain-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px}
.chain-item{background:#111;border:1px solid #1a1a1a;border-radius:8px;padding:10px 12px}
.chain-name{font-size:12px;color:#a1a1aa;font-weight:500;margin-bottom:4px}
.chain-val{font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:600;color:#e4e4e7}
.chain-pct{font-family:'JetBrains Mono',monospace;font-size:11px;color:#71717a}

/* Loading */
.loading{display:flex;align-items:center;justify-content:center;gap:8px;padding:40px;color:#71717a;font-size:13px}
.spinner{width:18px;height:18px;border:2px solid #333;border-top-color:#a78bfa;border-radius:50%;animation:spin 0.8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* Toast */
.toast{position:fixed;bottom:20px;right:20px;background:#22c55e;color:#000;padding:10px 16px;border-radius:8px;font-size:13px;font-weight:600;z-index:9999;opacity:0;transform:translateY(10px);transition:all 0.3s ease;pointer-events:none}
.toast.show{opacity:1;transform:translateY(0)}

/* Last updated */
.last-updated{text-align:center;font-size:11px;color:#52525b;margin-top:8px}

/* Scroll table */
.table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch}

/* Responsive */
@media(max-width:640px){
  .top-nav{gap:12px;padding:0 10px}
  .nav-logo{font-size:13px}
  .nav-title{font-size:12px}
  .summary-value{font-size:16px}
  .chart-wrapper{height:260px}
  .watermark::after{font-size:20px}
  .coin-table td,.coin-table th{padding:8px 6px;font-size:12px}
  .chain-grid{grid-template-columns:repeat(auto-fill,minmax(120px,1fr))}
}
</style>
</head>
<body>

<nav class="top-nav">
    <div class="nav-logo">Herdvibe</div>
    <div class="nav-title">ìŠ¤í…Œì´ë¸”ì½”ì¸ ëŒ€ì‹œë³´ë“œ</div>
</nav>

<div class="container">
    <!-- Summary -->
    <div class="summary-grid" id="summary-grid">
        <div class="summary-card"><div class="summary-label">ì „ì²´ ì‹œê°€ì´ì•¡</div><div class="summary-value" id="total-mcap">-</div><div class="summary-sub" id="total-mcap-change">-</div></div>
        <div class="summary-card"><div class="summary-label">USDT ì ìœ ìœ¨</div><div class="summary-value" id="usdt-dom">-</div><div class="summary-sub" id="usdt-mcap-sub">-</div></div>
        <div class="summary-card"><div class="summary-label">USDC ì ìœ ìœ¨</div><div class="summary-value" id="usdc-dom">-</div><div class="summary-sub" id="usdc-mcap-sub">-</div></div>
        <div class="summary-card"><div class="summary-label">ê¸°íƒ€ ìŠ¤í…Œì´ë¸”ì½”ì¸</div><div class="summary-value" id="others-mcap">-</div><div class="summary-sub" id="others-count">-</div></div>
    </div>

    <!-- Market Cap History Chart -->
    <div class="card">
        <div class="card-title">ğŸ“Š ìŠ¤í…Œì´ë¸”ì½”ì¸ ì‹œê°€ì´ì•¡ ì¶”ì´</div>
        <div class="tabs" id="period-tabs">
            <button class="tab active" data-v="365">1ë…„</button>
            <button class="tab" data-v="180">6ê°œì›”</button>
            <button class="tab" data-v="90">3ê°œì›”</button>
            <button class="tab" data-v="30">1ê°œì›”</button>
            <button class="tab" data-v="0">ì „ì²´</button>
        </div>
        <div class="chart-box">
            <div class="chart-wrapper watermark"><canvas id="mcap-chart"></canvas></div>
        </div>
    </div>

    <!-- Dominance Chart -->
    <div class="card">
        <div class="card-title">ğŸ¥§ ìŠ¤í…Œì´ë¸”ì½”ì¸ ì ìœ ìœ¨</div>
        <div style="display:flex;gap:16px;flex-wrap:wrap;align-items:center;justify-content:center">
            <div style="width:260px;height:260px;position:relative"><canvas id="dom-chart"></canvas></div>
            <div id="dom-legend" style="font-size:13px;display:flex;flex-direction:column;gap:6px"></div>
        </div>
    </div>

    <!-- Top Stablecoins Table -->
    <div class="card">
        <div class="card-title">ğŸ† ìƒìœ„ ìŠ¤í…Œì´ë¸”ì½”ì¸</div>
        <div class="table-wrap">
            <table class="coin-table">
                <thead><tr><th>#</th><th>ì´ë¦„</th><th>ì‹œê°€ì´ì•¡</th><th>7ì¼ ë³€ë™</th><th>ì ìœ ìœ¨</th><th>í˜ê·¸</th></tr></thead>
                <tbody id="coin-tbody"><tr><td colspan="6"><div class="loading"><div class="spinner"></div>ë°ì´í„° ë¡œë”© ì¤‘...</div></td></tr></tbody>
            </table>
        </div>
    </div>

    <!-- Chain Distribution -->
    <div class="card">
        <div class="card-title">â›“ï¸ ì²´ì¸ë³„ ìŠ¤í…Œì´ë¸”ì½”ì¸ ë¶„í¬</div>
        <div class="chart-box">
            <div class="chart-wrapper watermark" style="height:300px"><canvas id="chain-chart"></canvas></div>
        </div>
        <div class="chain-grid" id="chain-grid"></div>
    </div>

    <!-- Individual Stablecoin Charts -->
    <div class="card">
        <div class="card-title">ğŸ“ˆ ê°œë³„ ìŠ¤í…Œì´ë¸”ì½”ì¸ ì‹œê°€ì´ì•¡ ì¶”ì´</div>
        <div class="tabs" id="coin-tabs"></div>
        <div class="chart-box">
            <div class="chart-wrapper watermark"><canvas id="individual-chart"></canvas></div>
        </div>
    </div>

    <!-- Share -->
    <div class="share-bar">
        <button class="share-btn twitter" onclick="shareTwitter()"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>íŠ¸ìœ„í„°</button>
        <button class="share-btn kakao" onclick="shareKakao()"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3c-5.52 0-10 3.36-10 7.5 0 2.66 1.74 5 4.36 6.33-.14.53-.9 3.4-.93 3.61 0 0-.02.17.09.23.11.07.24.03.24.03.32-.04 3.7-2.42 4.28-2.83.62.09 1.27.13 1.96.13 5.52 0 10-3.36 10-7.5S17.52 3 12 3z"/></svg>ì¹´ì¹´ì˜¤í†¡</button>
        <button class="share-btn telegram" onclick="shareTelegram()"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.479.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>í…”ë ˆê·¸ë¨</button>
        <button class="share-btn copy" onclick="copyLink()" id="copyLinkBtn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>ë§í¬ë³µì‚¬</button>
    </div>

    <div class="last-updated" id="last-updated"></div>
</div>

<div class="toast" id="toast"></div>

<script>
const SHARE_URL = 'https://herdvibe.com/stablecoin-dashboard';
const SHARE_TITLE = 'ìŠ¤í…Œì´ë¸”ì½”ì¸ ëŒ€ì‹œë³´ë“œ - ì‹¤ì‹œê°„ ì‹œê°€ì´ì•¡ & ì ìœ ìœ¨';
const SHARE_DESC = 'ìŠ¤í…Œì´ë¸”ì½”ì¸ ì‹œì¥ ì‹¤ì‹œê°„ ë¶„ì„ ëŒ€ì‹œë³´ë“œ | Herdvibe';

const COLORS = ['#a78bfa','#38bdf8','#22c55e','#f59e0b','#ef4444','#ec4899','#06b6d4','#84cc16','#f97316','#8b5cf6','#14b8a6','#e879f9'];
const TOP_COINS = ['USDT','USDC','DAI','USDe','USDS','FDUSD','PYUSD','TUSD','BUSD','USD1','RLUSD','USDX'];

let allStablecoins = [];
let chainData = [];
let historyCache = {};
let mcapChart, domChart, chainChart, individualChart;

// Format
function fmt(n, d=1) {
    if (n >= 1e12) return '$' + (n/1e12).toFixed(d) + 'T';
    if (n >= 1e9) return '$' + (n/1e9).toFixed(d) + 'B';
    if (n >= 1e6) return '$' + (n/1e6).toFixed(d) + 'M';
    return '$' + n.toFixed(0);
}
function pct(n) { return (n >= 0 ? '+' : '') + n.toFixed(2) + '%'; }

// Toast
function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 3000);
}

// Share
function shareTwitter() {
    window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(SHARE_TITLE)}&url=${encodeURIComponent(SHARE_URL)}`, '_blank');
}
function shareKakao() {
    if (window.Kakao && !Kakao.isInitialized()) Kakao.init('a43ed7b39fac35458f4f9df925a279b5');
    if (window.Kakao) {
        Kakao.Share.sendDefault({
            objectType: 'feed',
            content: { title: SHARE_TITLE, description: SHARE_DESC, imageUrl: 'https://herdvibe.com/og-stablecoin.png', link: { mobileWebUrl: SHARE_URL, webUrl: SHARE_URL } }
        });
    }
}
function shareTelegram() {
    window.open(`https://t.me/share/url?url=${encodeURIComponent(SHARE_URL)}&text=${encodeURIComponent(SHARE_TITLE)}`, '_blank');
}
function copyLink() {
    const btn = document.getElementById('copyLinkBtn');
    try {
        if (window.parent !== window) {
            window.parent.postMessage({ type: 'copy', text: SHARE_URL }, '*');
        } else {
            navigator.clipboard.writeText(SHARE_URL);
        }
        btn.classList.add('copied');
        btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>ë³µì‚¬ë¨!';
        showToast('ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤ âœ“');
        setTimeout(() => {
            btn.classList.remove('copied');
            btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>ë§í¬ë³µì‚¬';
        }, 2000);
    } catch(e) { showToast('ë³µì‚¬ ì‹¤íŒ¨'); }
}

// Fetch
async function fetchJSON(url) {
    const r = await fetch(url);
    if (!r.ok) throw new Error(r.status);
    return r.json();
}

// Init
async function init() {
    try {
        const [stables, chains] = await Promise.all([
            fetchJSON('https://stablecoins.llama.fi/stablecoins?includePrices=true'),
            fetchJSON('https://stablecoins.llama.fi/stablecoinchains')
        ]);

        allStablecoins = (stables.peggedAssets || [])
            .filter(s => s.pegType === 'peggedUSD')
            .sort((a, b) => (b.circulating?.peggedUSD || 0) - (a.circulating?.peggedUSD || 0));

        chainData = (chains || []).sort((a, b) => {
            const aVal = a.totalCirculatingUSD?.peggedUSD || 0;
            const bVal = b.totalCirculatingUSD?.peggedUSD || 0;
            return bVal - aVal;
        });

        renderSummary();
        renderTable();
        renderDominance();
        renderChains();
        await loadMcapHistory();
        setupCoinTabs();

        document.getElementById('last-updated').textContent = 'ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ' + new Date().toLocaleString('ko-KR');
    } catch (e) {
        console.error('Init error:', e);
        document.getElementById('coin-tbody').innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px;color:#ef4444">ë°ì´í„° ë¡œë”© ì‹¤íŒ¨. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</td></tr>';
    }
}

// Summary
function renderSummary() {
    const total = allStablecoins.reduce((s, c) => s + (c.circulating?.peggedUSD || 0), 0);
    const usdt = allStablecoins.find(c => c.symbol === 'USDT');
    const usdc = allStablecoins.find(c => c.symbol === 'USDC');
    const usdtMcap = usdt?.circulating?.peggedUSD || 0;
    const usdcMcap = usdc?.circulating?.peggedUSD || 0;
    const othersMcap = total - usdtMcap - usdcMcap;

    document.getElementById('total-mcap').textContent = fmt(total, 1);
    const totalChange7d = calcChange7d(allStablecoins);
    const chEl = document.getElementById('total-mcap-change');
    chEl.textContent = '7ì¼ ' + pct(totalChange7d);
    chEl.className = 'summary-sub ' + (totalChange7d >= 0 ? 'up' : 'down');

    document.getElementById('usdt-dom').textContent = (usdtMcap / total * 100).toFixed(1) + '%';
    document.getElementById('usdt-mcap-sub').textContent = fmt(usdtMcap, 1);
    document.getElementById('usdt-mcap-sub').className = 'summary-sub';

    document.getElementById('usdc-dom').textContent = (usdcMcap / total * 100).toFixed(1) + '%';
    document.getElementById('usdc-mcap-sub').textContent = fmt(usdcMcap, 1);
    document.getElementById('usdc-mcap-sub').className = 'summary-sub';

    document.getElementById('others-mcap').textContent = fmt(othersMcap, 1);
    document.getElementById('others-count').textContent = (allStablecoins.length - 2) + 'ê°œ ì½”ì¸';
    document.getElementById('others-count').className = 'summary-sub';
}

function calcChange7d(coins) {
    let now = 0, prev = 0;
    coins.forEach(c => {
        const curr = c.circulating?.peggedUSD || 0;
        const p = c.circulatingPrevWeek?.peggedUSD || curr;
        now += curr;
        prev += p;
    });
    return prev > 0 ? ((now - prev) / prev) * 100 : 0;
}

// Table
function renderTable() {
    const total = allStablecoins.reduce((s, c) => s + (c.circulating?.peggedUSD || 0), 0);
    const top = allStablecoins.slice(0, 15);
    const tbody = document.getElementById('coin-tbody');

    tbody.innerHTML = top.map((c, i) => {
        const mcap = c.circulating?.peggedUSD || 0;
        const prev = c.circulatingPrevWeek?.peggedUSD || mcap;
        const change = prev > 0 ? ((mcap - prev) / prev) * 100 : 0;
        const dom = (mcap / total * 100);
        const price = c.price || 1;
        const pegDev = Math.abs(price - 1) * 100;
        const pegClass = pegDev < 0.1 ? 'peg-ok' : pegDev < 0.5 ? 'peg-warn' : 'peg-bad';
        const color = COLORS[i % COLORS.length];

        return `<tr>
            <td style="color:#71717a;font-size:12px">${i + 1}</td>
            <td><div class="coin-name"><div class="coin-icon" style="color:${color};border:1px solid ${color}33">${c.symbol?.charAt(0) || '?'}</div><div><div class="coin-symbol">${c.symbol || '-'}</div><div class="coin-fullname">${c.name || ''}</div></div></div></td>
            <td class="mcap-val">${fmt(mcap, 2)}</td>
            <td class="change-val ${change >= 0 ? 'up' : 'down'}">${pct(change)}</td>
            <td><div class="dom-bar"><div class="dom-fill" style="width:${Math.max(dom, 1)}%;background:${color}"></div></div><div style="font-family:'JetBrains Mono';font-size:11px;color:#71717a;margin-top:2px">${dom.toFixed(1)}%</div></td>
            <td class="peg-val ${pegClass}">${price ? '$' + price.toFixed(4) : '-'}</td>
        </tr>`;
    }).join('');
}

// Dominance Pie
function renderDominance() {
    const total = allStablecoins.reduce((s, c) => s + (c.circulating?.peggedUSD || 0), 0);
    const topN = allStablecoins.slice(0, 8);
    const topSum = topN.reduce((s, c) => s + (c.circulating?.peggedUSD || 0), 0);
    const labels = [...topN.map(c => c.symbol), 'ê¸°íƒ€'];
    const data = [...topN.map(c => c.circulating?.peggedUSD || 0), total - topSum];
    const colors = [...COLORS.slice(0, 8), '#333'];

    const ctx = document.getElementById('dom-chart').getContext('2d');
    domChart = new Chart(ctx, {
        type: 'doughnut',
        data: { labels, datasets: [{ data, backgroundColor: colors, borderWidth: 0, hoverBorderWidth: 2, hoverBorderColor: '#fff' }] },
        options: {
            responsive: true, maintainAspectRatio: true,
            cutout: '55%',
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: '#1a1a1a', titleColor: '#e4e4e7', bodyColor: '#a1a1aa', borderColor: '#333', borderWidth: 1,
                    callbacks: { label: ctx => `${ctx.label}: ${fmt(ctx.parsed, 1)} (${(ctx.parsed / total * 100).toFixed(1)}%)` }
                }
            }
        }
    });

    // Legend
    const legendEl = document.getElementById('dom-legend');
    legendEl.innerHTML = labels.map((l, i) => {
        const v = data[i];
        return `<div style="display:flex;align-items:center;gap:8px"><div style="width:10px;height:10px;border-radius:2px;background:${colors[i]};flex-shrink:0"></div><span style="color:#a1a1aa;min-width:55px">${l}</span><span style="font-family:'JetBrains Mono';color:#e4e4e7;font-size:12px">${fmt(v,1)}</span><span style="font-family:'JetBrains Mono';color:#71717a;font-size:11px">${(v/total*100).toFixed(1)}%</span></div>`;
    }).join('');
}

// Chain
function renderChains() {
    const totalChain = chainData.reduce((s, c) => s + (c.totalCirculatingUSD?.peggedUSD || 0), 0);
    const top10 = chainData.slice(0, 10);
    const otherSum = totalChain - top10.reduce((s, c) => s + (c.totalCirculatingUSD?.peggedUSD || 0), 0);
    const labels = [...top10.map(c => c.name), 'ê¸°íƒ€'];
    const data = [...top10.map(c => c.totalCirculatingUSD?.peggedUSD || 0), otherSum];

    const ctx = document.getElementById('chain-chart').getContext('2d');
    chainChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels,
            datasets: [{
                data,
                backgroundColor: COLORS.slice(0, 11),
                borderRadius: 4,
                borderSkipped: false,
                maxBarThickness: 50
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            indexAxis: 'y',
            scales: {
                x: { grid: { color: '#1a1a1a' }, ticks: { color: '#71717a', font: { family: 'JetBrains Mono', size: 10 }, callback: v => fmt(v, 0) } },
                y: { grid: { display: false }, ticks: { color: '#a1a1aa', font: { family: 'Noto Sans KR', size: 11 } } }
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: '#1a1a1a', titleColor: '#e4e4e7', bodyColor: '#a1a1aa', borderColor: '#333', borderWidth: 1,
                    callbacks: { label: ctx => fmt(ctx.parsed.x, 2) + ' (' + (ctx.parsed.x / totalChain * 100).toFixed(1) + '%)' }
                }
            }
        }
    });

    // Grid
    const grid = document.getElementById('chain-grid');
    grid.innerHTML = top10.map(c => {
        const v = c.totalCirculatingUSD?.peggedUSD || 0;
        return `<div class="chain-item"><div class="chain-name">${c.name}</div><div class="chain-val">${fmt(v, 1)}</div><div class="chain-pct">${(v / totalChain * 100).toFixed(1)}%</div></div>`;
    }).join('');
}

// History Chart
async function loadMcapHistory(days = 365) {
    try {
        const key = 'all';
        if (!historyCache[key]) {
            const data = await fetchJSON('https://stablecoins.llama.fi/stablecoincharts/all?stablecoin=');
            historyCache[key] = data;
        }
        const raw = historyCache[key] || [];
        let filtered = raw;
        if (days > 0) {
            const cutoff = Date.now() / 1000 - days * 86400;
            filtered = raw.filter(d => d.date >= cutoff);
        }
        const labels = filtered.map(d => new Date(d.date * 1000));
        const values = filtered.map(d => d.totalCirculating?.peggedUSD || d.totalCirculatingUSD?.peggedUSD || 0);

        if (mcapChart) mcapChart.destroy();
        const ctx = document.getElementById('mcap-chart').getContext('2d');

        const gradient = ctx.createLinearGradient(0, 0, 0, 340);
        gradient.addColorStop(0, 'rgba(167,139,250,0.25)');
        gradient.addColorStop(1, 'rgba(167,139,250,0)');

        mcapChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels,
                datasets: [{
                    label: 'ì „ì²´ ì‹œê°€ì´ì•¡',
                    data: values,
                    borderColor: '#a78bfa',
                    backgroundColor: gradient,
                    fill: true,
                    tension: 0.3,
                    pointRadius: 0,
                    pointHitRadius: 10,
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                scales: {
                    x: { type: 'time', time: { tooltipFormat: 'yyyy-MM-dd' }, grid: { color: '#1a1a1a' }, ticks: { color: '#71717a', maxTicksLimit: 8, font: { family: 'JetBrains Mono', size: 10 } } },
                    y: { grid: { color: '#1a1a1a' }, ticks: { color: '#71717a', font: { family: 'JetBrains Mono', size: 10 }, callback: v => fmt(v, 0) } }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: '#1a1a1a', titleColor: '#e4e4e7', bodyColor: '#a1a1aa', borderColor: '#333', borderWidth: 1,
                        callbacks: { label: ctx => fmt(ctx.parsed.y, 2) }
                    }
                }
            }
        });
    } catch (e) {
        console.error('History load error:', e);
    }
}

// Period tabs
document.getElementById('period-tabs').addEventListener('click', e => {
    const btn = e.target.closest('.tab');
    if (!btn) return;
    document.querySelectorAll('#period-tabs .tab').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
    loadMcapHistory(parseInt(btn.dataset.v));
});

// Individual coin tabs & chart
function setupCoinTabs() {
    const tabsEl = document.getElementById('coin-tabs');
    const topCoins = allStablecoins.slice(0, 8);
    tabsEl.innerHTML = topCoins.map((c, i) =>
        `<button class="tab ${i === 0 ? 'active' : ''}" data-id="${c.id}" data-symbol="${c.symbol}">${c.symbol}</button>`
    ).join('');

    tabsEl.addEventListener('click', async e => {
        const btn = e.target.closest('.tab');
        if (!btn) return;
        tabsEl.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        btn.classList.add('active');
        await loadIndividualChart(btn.dataset.id, btn.dataset.symbol);
    });

    if (topCoins.length > 0) {
        loadIndividualChart(topCoins[0].id, topCoins[0].symbol);
    }
}

async function loadIndividualChart(id, symbol) {
    try {
        const cacheKey = `coin_${id}`;
        if (!historyCache[cacheKey]) {
            const data = await fetchJSON(`https://stablecoins.llama.fi/stablecoin/${id}`);
            historyCache[cacheKey] = data;
        }
        const coinData = historyCache[cacheKey];
        const tokens = coinData.tokens || [];

        // Aggregate all chains
        const dateMap = {};
        tokens.forEach(entry => {
            const date = entry.date;
            if (!dateMap[date]) dateMap[date] = 0;
            const circ = entry.circulating?.peggedUSD || 0;
            dateMap[date] += circ;
        });

        const sorted = Object.entries(dateMap).sort((a, b) => a[0] - b[0]);
        // Last 365 days
        const cutoff = Date.now() / 1000 - 365 * 86400;
        const filtered = sorted.filter(([d]) => parseInt(d) >= cutoff);

        const labels = filtered.map(([d]) => new Date(parseInt(d) * 1000));
        const values = filtered.map(([, v]) => v);

        const colorIdx = allStablecoins.findIndex(c => c.id == id);
        const color = COLORS[colorIdx >= 0 ? colorIdx % COLORS.length : 0];

        if (individualChart) individualChart.destroy();
        const ctx = document.getElementById('individual-chart').getContext('2d');

        const gradient = ctx.createLinearGradient(0, 0, 0, 340);
        gradient.addColorStop(0, color + '40');
        gradient.addColorStop(1, color + '00');

        individualChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels,
                datasets: [{
                    label: symbol + ' ì‹œê°€ì´ì•¡',
                    data: values,
                    borderColor: color,
                    backgroundColor: gradient,
                    fill: true,
                    tension: 0.3,
                    pointRadius: 0,
                    pointHitRadius: 10,
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                scales: {
                    x: { type: 'time', time: { tooltipFormat: 'yyyy-MM-dd' }, grid: { color: '#1a1a1a' }, ticks: { color: '#71717a', maxTicksLimit: 8, font: { family: 'JetBrains Mono', size: 10 } } },
                    y: { grid: { color: '#1a1a1a' }, ticks: { color: '#71717a', font: { family: 'JetBrains Mono', size: 10 }, callback: v => fmt(v, 0) } }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: '#1a1a1a', titleColor: '#e4e4e7', bodyColor: '#a1a1aa', borderColor: '#333', borderWidth: 1,
                        callbacks: { label: ctx => symbol + ': ' + fmt(ctx.parsed.y, 2) }
                    }
                }
            }
        });
    } catch (e) {
        console.error('Individual chart error:', e);
    }
}

// Start
init();
</script>
</body>
</html>
