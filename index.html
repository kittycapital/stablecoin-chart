<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>스테이블코인 발행량</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background-color: #000; margin: 0; }
    .loader {
      border: 3px solid #333;
      border-top: 3px solid #fff;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-black text-white min-h-screen">
  <div id="app" class="max-w-7xl mx-auto p-6">
    <!-- Loading State -->
    <div id="loading" class="flex flex-col items-center justify-center min-h-screen">
      <div class="loader mb-4"></div>
      <p class="text-gray-400">DefiLlama에서 데이터를 불러오는 중...</p>
    </div>

    <!-- Main Content (hidden initially) -->
    <div id="content" class="hidden">
      <!-- Header -->
      <div class="mb-8">
        <h1 class="text-3xl font-bold mb-2">스테이블코인 발행량</h1>
        <p class="text-gray-500">데이터 출처: DefiLlama API</p>
      </div>

      <!-- Stats Cards -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
        <div class="bg-gray-900/50 rounded-xl p-5 border border-gray-800">
          <p class="text-gray-400 text-sm mb-1">총 발행량</p>
          <p id="totalSupply" class="text-2xl font-bold text-white">-</p>
        </div>
        <div class="bg-gray-900/50 rounded-xl p-5 border border-gray-800">
          <p class="text-gray-400 text-sm mb-1">1위 스테이블코인</p>
          <p id="topStablecoin" class="text-2xl font-bold">-</p>
          <p id="topStablecoinValue" class="text-gray-500 text-sm">-</p>
        </div>
        <div class="bg-gray-900/50 rounded-xl p-5 border border-gray-800">
          <p class="text-gray-400 text-sm mb-1">추적 중인 스테이블코인</p>
          <p class="text-2xl font-bold text-white">상위 10개 + 기타</p>
        </div>
      </div>

      <!-- Controls -->
      <div class="flex flex-wrap justify-between items-center gap-4 mb-6">
        <!-- Tabs -->
        <div class="flex bg-gray-900 rounded-lg p-1">
          <button id="barTabBtn" onclick="switchTab('bar')" class="px-4 py-2 rounded-md font-medium transition bg-white text-black">
            막대 차트
          </button>
          <button id="pieTabBtn" onclick="switchTab('pie')" class="px-4 py-2 rounded-md font-medium transition text-gray-400 hover:text-white">
            파이 차트
          </button>
        </div>

        <!-- Time Range -->
        <div id="timeRangeButtons" class="flex gap-2">
          <button onclick="setTimeRange('3M')" class="time-btn px-4 py-2 rounded-lg font-medium transition bg-gray-900 text-gray-400 hover:text-white" data-range="3M">3M</button>
          <button onclick="setTimeRange('6M')" class="time-btn px-4 py-2 rounded-lg font-medium transition bg-gray-900 text-gray-400 hover:text-white" data-range="6M">6M</button>
          <button onclick="setTimeRange('1Y')" class="time-btn px-4 py-2 rounded-lg font-medium transition bg-gray-900 text-gray-400 hover:text-white" data-range="1Y">1Y</button>
          <button onclick="setTimeRange('ALL')" class="time-btn px-4 py-2 rounded-lg font-medium transition bg-white text-black" data-range="ALL">ALL</button>
        </div>
      </div>

      <!-- Bar Chart Container -->
      <div id="barChartContainer" class="bg-gray-900/30 rounded-xl p-6 border border-gray-800">
        <div class="flex">
          <div class="flex-1" style="height: 500px;">
            <canvas id="barChart"></canvas>
          </div>
          <div id="barLegend" class="w-40 flex-shrink-0 pl-4">
            <p class="text-gray-400 text-xs mb-3">범례 (클릭하여 토글)</p>
          </div>
        </div>
      </div>

      <!-- Pie Chart Container -->
      <div id="pieChartContainer" class="bg-gray-900/30 rounded-xl p-6 border border-gray-800 hidden">
        <div class="flex">
          <div class="flex-1 flex justify-center" style="height: 500px;">
            <canvas id="pieChart" style="max-width: 500px;"></canvas>
          </div>
          <div id="pieLegend" class="w-40 flex-shrink-0 pl-4">
            <p class="text-gray-400 text-xs mb-3">범례 (클릭하여 토글)</p>
          </div>
        </div>

        <!-- Table -->
        <div class="mt-6 overflow-x-auto">
          <table class="w-full">
            <thead>
              <tr class="text-left text-gray-400 text-sm border-b border-gray-800">
                <th class="pb-3 pl-4">#</th>
                <th class="pb-3">이름</th>
                <th class="pb-3 text-right">발행량</th>
                <th class="pb-3 text-right pr-4">점유율</th>
              </tr>
            </thead>
            <tbody id="pieTable"></tbody>
          </table>
        </div>
      </div>

      <!-- Footer -->
      <div class="text-center text-gray-600 text-sm mt-8">
        <p>DefiLlama API를 통해 실시간 업데이트</p>
      </div>
    </div>
  </div>

  <script>
    // Brand colors
    const STABLECOIN_COLORS = {
      'USDT': '#26A17B',
      'USDC': '#2775CA',
      'DAI': '#F5AC37',
      'FDUSD': '#5BC0EB',
      'TUSD': '#1A237E',
      'USDD': '#8B5CF6',
      'FRAX': '#DC2626',
      'LUSD': '#3B82F6',
      'USDP': '#10B981',
      'GUSD': '#00DCFA',
      'PYUSD': '#0066CC',
      'USDe': '#14B8A6',
      'USDS': '#F59E0B',
      'BUSD': '#F0B90B',
      'crvUSD': '#FF6B6B',
      'GHO': '#8B5CF6',
      '기타': '#6B7280',
    };

    const FALLBACK_COLORS = ['#EC4899', '#8B5CF6', '#06B6D4', '#84CC16', '#F97316', '#EF4444', '#A855F7', '#22D3EE', '#FACC15', '#FB7185'];

    function getColor(symbol, index) {
      return STABLECOIN_COLORS[symbol] || FALLBACK_COLORS[index % FALLBACK_COLORS.length];
    }

    function formatBillion(value) {
      if (value >= 1e9) return `$${(value / 1e9).toFixed(1)}B`;
      if (value >= 1e6) return `$${(value / 1e6).toFixed(1)}M`;
      return `$${value.toFixed(0)}`;
    }

    // Global state
    let allHistoricalData = [];
    let pieData = [];
    let topStablecoins = [];
    let currentTimeRange = 'ALL';
    let currentTab = 'bar';
    let barChart = null;
    let pieChart = null;
    let hiddenCoins = new Set();

    // Fetch and initialize
    async function init() {
      try {
        // Fetch current stablecoins
        const stableRes = await fetch('https://stablecoins.llama.fi/stablecoins?includePrices=true');
        const stableData = await stableRes.json();

        const sorted = stableData.peggedAssets
          .filter(s => s.circulating?.peggedUSD > 0)
          .sort((a, b) => (b.circulating?.peggedUSD || 0) - (a.circulating?.peggedUSD || 0));

        const top10 = sorted.slice(0, 10);
        topStablecoins = top10.map(s => s.symbol);

        const othersTotal = sorted.slice(10).reduce((sum, s) => sum + (s.circulating?.peggedUSD || 0), 0);

        pieData = [
          ...top10.map(s => ({
            name: s.symbol,
            value: s.circulating?.peggedUSD || 0,
            fullName: s.name
          })),
          { name: '기타', value: othersTotal, fullName: '기타 스테이블코인' }
        ];

        // Fetch historical data
        const historicalPromises = top10.map(s =>
          fetch(`https://stablecoins.llama.fi/stablecoin/${s.id}`)
            .then(res => res.json())
            .then(data => ({ symbol: s.symbol, data: data.tokens || [] }))
        );

        const totalHistRes = await fetch('https://stablecoins.llama.fi/stablecoincharts/all');
        const totalHistData = await totalHistRes.json();

        const historicalResults = await Promise.all(historicalPromises);

        // Process data
        const dateMap = new Map();

        historicalResults.forEach(({ symbol, data }) => {
          data.forEach(item => {
            const date = item.date;
            const value = item.circulating?.peggedUSD || 0;
            if (!dateMap.has(date)) {
              dateMap.set(date, { date });
            }
            dateMap.get(date)[symbol] = value;
          });
        });

        totalHistData.forEach(item => {
          const date = item.date;
          const total = item.totalCirculating?.peggedUSD || 0;
          if (dateMap.has(date)) {
            const existing = dateMap.get(date);
            const top10Sum = topStablecoins.reduce((sum, sym) => sum + (existing[sym] || 0), 0);
            existing['기타'] = Math.max(0, total - top10Sum);
            existing.total = total;
          }
        });

        // Group by month
        const monthlyMap = new Map();
        Array.from(dateMap.values())
          .filter(d => d.total > 0)
          .sort((a, b) => a.date - b.date)
          .forEach(item => {
            const dateObj = new Date(item.date * 1000);
            const monthKey = `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, '0')}`;
            const monthLabel = dateObj.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
            monthlyMap.set(monthKey, { ...item, monthLabel });
          });

        allHistoricalData = Array.from(monthlyMap.values()).sort((a, b) => a.date - b.date);

        // Update UI
        const totalSupply = pieData.reduce((sum, d) => sum + d.value, 0);
        document.getElementById('totalSupply').textContent = formatBillion(totalSupply);
        document.getElementById('topStablecoin').textContent = pieData[0].name;
        document.getElementById('topStablecoin').style.color = getColor(pieData[0].name, 0);
        document.getElementById('topStablecoinValue').textContent = formatBillion(pieData[0].value);

        // Build charts
        buildBarChart();
        buildPieChart();
        buildLegends();
        buildPieTable();

        // Show content
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('content').classList.remove('hidden');

      } catch (error) {
        console.error('Error:', error);
        document.getElementById('loading').innerHTML = `
          <div class="bg-red-900/20 border border-red-500 rounded-lg p-6">
            <h2 class="text-red-400 font-semibold mb-2">데이터 로딩 오류</h2>
            <p class="text-gray-400">${error.message}</p>
          </div>
        `;
      }
    }

    function filterDataByRange(data) {
      if (currentTimeRange === 'ALL') return data;
      const now = Date.now() / 1000;
      const ranges = { '1Y': 365 * 86400, '6M': 180 * 86400, '3M': 90 * 86400 };
      return data.filter(d => d.date > now - ranges[currentTimeRange]);
    }

    function buildBarChart() {
      const ctx = document.getElementById('barChart').getContext('2d');
      const filteredData = filterDataByRange(allHistoricalData);
      const allCoins = [...topStablecoins, '기타'];
      const visibleCoins = allCoins.filter(c => !hiddenCoins.has(c));

      const datasets = visibleCoins.map((coin, i) => ({
        label: coin,
        data: filteredData.map(d => d[coin] || 0),
        backgroundColor: getColor(coin, allCoins.indexOf(coin)),
        borderWidth: 0,
      }));

      if (barChart) barChart.destroy();

      barChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: filteredData.map(d => d.monthLabel),
          datasets: datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              mode: 'index',
              intersect: false,
              backgroundColor: '#1f2937',
              titleColor: '#fff',
              bodyColor: '#d1d5db',
              borderColor: '#374151',
              borderWidth: 1,
              padding: 12,
              callbacks: {
                afterBody: function(context) {
                  const total = context.reduce((sum, c) => sum + (c.raw || 0), 0);
                  return `\n총 발행량: ${formatBillion(total)}`;
                },
                label: function(context) {
                  return `${context.dataset.label}: ${formatBillion(context.raw)}`;
                }
              }
            }
          },
          scales: {
            x: {
              stacked: true,
              ticks: { color: '#6B7280', maxRotation: 45, minRotation: 45 },
              grid: { display: false }
            },
            y: {
              stacked: true,
              ticks: {
                color: '#6B7280',
                callback: (value) => `$${(value / 1e9).toFixed(0)}B`
              },
              grid: { color: '#1f2937' }
            }
          }
        }
      });
    }

    function buildPieChart() {
      const ctx = document.getElementById('pieChart').getContext('2d');
      const allCoins = [...topStablecoins, '기타'];
      const visibleData = pieData.filter(d => !hiddenCoins.has(d.name));

      if (pieChart) pieChart.destroy();

      pieChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: visibleData.map(d => d.name),
          datasets: [{
            data: visibleData.map(d => d.value),
            backgroundColor: visibleData.map(d => getColor(d.name, allCoins.indexOf(d.name))),
            borderWidth: 2,
            borderColor: '#000'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '55%',
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: '#1f2937',
              titleColor: '#fff',
              bodyColor: '#d1d5db',
              borderColor: '#374151',
              borderWidth: 1,
              padding: 12,
              callbacks: {
                label: function(context) {
                  const total = pieData.reduce((sum, d) => sum + d.value, 0);
                  const percentage = ((context.raw / total) * 100).toFixed(1);
                  return [
                    `${formatBillion(context.raw)}`,
                    `시장 점유율: ${percentage}%`
                  ];
                }
              }
            }
          }
        }
      });
    }

    function buildLegends() {
      const allCoins = [...topStablecoins, '기타'];
      
      const createLegend = (containerId) => {
        const container = document.getElementById(containerId);
        const existingButtons = container.querySelectorAll('button');
        existingButtons.forEach(btn => btn.remove());

        allCoins.forEach((coin, index) => {
          const btn = document.createElement('button');
          btn.className = 'flex items-center gap-2 text-left w-full py-1 transition-opacity';
          btn.style.opacity = hiddenCoins.has(coin) ? '0.4' : '1';
          btn.innerHTML = `
            <div class="w-4 h-4 rounded-sm flex-shrink-0" style="background-color: ${getColor(coin, index)}"></div>
            <span class="text-gray-300 text-sm">${coin}</span>
          `;
          btn.onclick = () => toggleCoin(coin);
          container.appendChild(btn);
        });
      };

      createLegend('barLegend');
      createLegend('pieLegend');
    }

    function buildPieTable() {
      const tbody = document.getElementById('pieTable');
      const total = pieData.reduce((sum, d) => sum + d.value, 0);
      
      tbody.innerHTML = pieData.map((stable, i) => `
        <tr class="border-b border-gray-800/50 ${hiddenCoins.has(stable.name) ? 'opacity-40' : ''}">
          <td class="py-3 pl-4 text-gray-500">${i + 1}</td>
          <td class="py-3">
            <div class="flex items-center gap-2">
              <div class="w-3 h-3 rounded-sm" style="background-color: ${getColor(stable.name, i)}"></div>
              <span class="font-medium">${stable.name}</span>
              <span class="text-gray-500 text-sm">${stable.fullName}</span>
            </div>
          </td>
          <td class="py-3 text-right text-gray-300">${formatBillion(stable.value)}</td>
          <td class="py-3 text-right pr-4 text-gray-400">${((stable.value / total) * 100).toFixed(1)}%</td>
        </tr>
      `).join('');
    }

    function toggleCoin(coin) {
      if (hiddenCoins.has(coin)) {
        hiddenCoins.delete(coin);
      } else {
        hiddenCoins.add(coin);
      }
      buildBarChart();
      buildPieChart();
      buildLegends();
      buildPieTable();
    }

    function setTimeRange(range) {
      currentTimeRange = range;
      document.querySelectorAll('.time-btn').forEach(btn => {
        if (btn.dataset.range === range) {
          btn.className = 'time-btn px-4 py-2 rounded-lg font-medium transition bg-white text-black';
        } else {
          btn.className = 'time-btn px-4 py-2 rounded-lg font-medium transition bg-gray-900 text-gray-400 hover:text-white';
        }
      });
      buildBarChart();
    }

    function switchTab(tab) {
      currentTab = tab;
      const barBtn = document.getElementById('barTabBtn');
      const pieBtn = document.getElementById('pieTabBtn');
      const barContainer = document.getElementById('barChartContainer');
      const pieContainer = document.getElementById('pieChartContainer');
      const timeRangeButtons = document.getElementById('timeRangeButtons');

      if (tab === 'bar') {
        barBtn.className = 'px-4 py-2 rounded-md font-medium transition bg-white text-black';
        pieBtn.className = 'px-4 py-2 rounded-md font-medium transition text-gray-400 hover:text-white';
        barContainer.classList.remove('hidden');
        pieContainer.classList.add('hidden');
        timeRangeButtons.classList.remove('hidden');
      } else {
        pieBtn.className = 'px-4 py-2 rounded-md font-medium transition bg-white text-black';
        barBtn.className = 'px-4 py-2 rounded-md font-medium transition text-gray-400 hover:text-white';
        pieContainer.classList.remove('hidden');
        barContainer.classList.add('hidden');
        timeRangeButtons.classList.add('hidden');
      }
    }

    // Start the app
    init();
  </script>
</body>
</html>
